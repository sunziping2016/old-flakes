$eval: |
  with (.proxy-groups[];
    explode(.) |
    select(has("default") and has("proxies")) |
    . = . * {
      "proxies": ([.default] + .proxies | unique)
    } |
    del(.default)
  ) |
  .out.use = (env(PROXY_PROVIDERS) | keys) |
  .p as $p |
  .proxy-providers = (env(PROXY_PROVIDERS) |
    to_entries | map(
      .value = {
        "url": .value
      } * $p
    ) | from_entries
  ) |
  del(.$eval) |
  del(.in) |
  del(.out) |
  del(.p)

in: &in
  type: select
  proxies:
    - Proxy
    - DIRECT
    - REJECT
    - PASS

out: &out
  type: url-test
  use: []

p: &p
  type: http
  interval: 3600
  health-check:
    enable: true
    url: https://www.gstatic.com/generate_204
    interval: 300

proxy-providers: {}

mode: rule
ipv6: true
log-level: warning
allow-lan: false
mixed-port: 12311
unified-delay: false
tcp-concurrent: true
external-controller: 127.0.0.1:9090

geodata-mode: true
geox-url:
  geoip: "https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.dat"
  geosite: "https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geosite.dat"
  mmdb: "https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/country.mmdb"

find-process-mode: strict
global-client-fingerprint: chrome

profile:
  store-selected: true
  store-fake-ip: true

sniffer:
  enable: true
  sniff:
    TLS:
      ports: [443, 8443]
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true

tun:
  enable: true
  stack: system
  dns-hijack: []
  auto-route: true
  auto-detect-interface: true

dns:
  enable: true
  listen: 127.0.0.2:53
  ipv6: true
  enhanced-mode: fake-ip
  fake-ip-range: 28.0.0.1/8
  fake-ip-filter:
    - "+.lan"
    - "+.local"
  default-nameserver:
    - 127.0.0.1:53
  nameserver:
    - "tls://8.8.4.4#dns"
    - "tls://1.0.0.1#dns"
  proxy-server-nameserver:
    - https://doh.pub/dns-query
  nameserver-policy:
    "geosite:cn,private":
      - https://doh.pub/dns-query
      - https://dns.alidns.com/dns-query

proxy-groups:
  # incoming
  - name: Global
    <<: *in
    default: Proxy

  - name: YouTube
    <<: *in
    default: US

  - name: AI
    <<: *in
    default: SZP:US

  - name: SSH
    <<: *in
    default: SZP

  - name: BT
    <<: *in
    default: SZP

  - name: dns
    <<: *in
    default: Proxy

  - name: China
    <<: *in
    default: Proxy

  # outgoing
  - name: Proxy
    <<: *out

  - name: US
    <<: *out
    filter: "(?i)美国|us"

  - name: SZP
    <<: *out
    filter: "(?i)Misaka|咸鱼云"

  - name: SZP:US
    <<: *out
    filter: "(?i)(?=.*(Misaka|咸鱼云))(?=.*(美国|us))"

rules:
  - AND,(AND,(DST-PORT,443),(NETWORK,udp)),(GEOSITE,geolocation-!cn),REJECT
  - AND,(DST-PORT,22),(GEOSITE,geolocation-!cn),SSH
  - DOMAIN-SUFFIX,openai.com,AI
  - DOMAIN-SUFFIX,bing.com,AI
  - DOMAIN-SUFFIX,bard.google.com,AI
  - DOMAIN-SUFFIX,tracker.byr.pt,DIRECT
  - DOMAIN-SUFFIX,byr.pt,BT
  - GEOSITE,youtube,YouTube
  - GEOSITE,geolocation-!cn,Global
  - GEOSITE,CN,China
  - GEOIP,CN,China
  - MATCH,Global
